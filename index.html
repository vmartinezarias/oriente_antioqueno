<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor Oriente Antioque√±o - Merceditas</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Fuentes -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #0f172a;
            --accent-color: #3b82f6;
            --sidebar-width: 400px;
            --header-height: 70px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #334155;
            background-color: #f1f5f9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .logo-img {
            height: 50px;
            width: auto;
            object-fit: contain;
        }

        .header-title {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary-color);
            line-height: 1.2;
            max-width: 800px;
        }

        /* --- LAYOUT --- */
        #main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--header-height));
            position: relative;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 900;
        }

        .sidebar-content {
            padding: 25px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .welcome-icon { font-size: 4rem; margin-bottom: 20px; }

        /* Estilos de informaci√≥n del sector */
        .sector-header { margin-bottom: 20px; }
        .sector-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: 600; margin-bottom: 10px; }
        .sector-title { font-size: 1.8rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        .sector-emoji { font-size: 2.5rem; }
        
        .info-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-label { font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 5px; display: block; }
        .info-text { font-size: 0.95rem; line-height: 1.5; color: #334155; }
        .info-description { font-size: 1rem; line-height: 1.6; color: #475569; text-align: justify; }

        .close-sidebar-btn {
            display: none; /* Solo visible en movil */
            margin-bottom: 15px;
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 0.9rem;
            align-items: center;
            gap: 5px;
        }

        /* --- MAP --- */
        #map {
            flex: 1;
            height: 100%;
            background: #e2e8f0;
            z-index: 1;
        }

        /* --- LOADING OVERLAY --- */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            header { padding: 0 10px; height: auto; padding: 10px; }
            .logo-img { height: 40px; }
            .header-title { font-size: 0.7rem; }
            
            #sidebar {
                position: absolute;
                top: 0; left: 0;
                width: 100%;
                height: 100%;
                transform: translateX(100%); /* Oculto por defecto en m√≥vil */
            }
            #sidebar.active {
                transform: translateX(0);
            }
            .close-sidebar-btn { display: flex; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react-leaflet": "https://esm.sh/react-leaflet@^5.0.0",
    "leaflet": "https://esm.sh/leaflet@^1.9.4",
    "shpjs": "https://esm.sh/shpjs@^6.2.0",
    "leaflet/": "https://esm.sh/leaflet@^1.9.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>

    <!-- Pantalla de Carga -->
    <div id="loader">
        <div class="spinner"></div>
        <h3>Cargando Cartograf√≠a...</h3>
        <p style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">Leyendo archivo AreaEstudio.zip</p>
    </div>

    <!-- Encabezado -->
    <header>
        <div class="logo-container">
            <img src="./merceditas.png" alt="Merceditas Logo" class="logo-img" onerror="this.style.display='none'">
            <h1 class="header-title">
                M√°s all√° de las alertas tempranas: descifrando el v√≠nculo entre los focos de deforestaci√≥n y las din√°micas del paisaje para mejorar las estrategias de conservaci√≥n de la biodiversidad en el oriente Antioque√±o
            </h1>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <div id="main-container">
        <!-- Panel Lateral -->
        <aside id="sidebar">
            <div id="sidebar-welcome" class="welcome-screen">
                <div class="welcome-icon">üó∫Ô∏è</div>
                <h2>Explora el Territorio</h2>
                <p>Haz clic en cualquier zona coloreada del mapa para ver el detalle del sector y los municipios.</p>
            </div>
            
            <div id="sidebar-detail" class="sidebar-content" style="display: none;">
                <button class="close-sidebar-btn" onclick="closeSidebar()">‚Üê Volver al mapa</button>
                <div id="detail-content">
                    <!-- El contenido se inyecta aqu√≠ con JS -->
                </div>
            </div>
        </aside>

        <!-- Mapa -->
        <div id="map"></div>
    </div>

    <!-- LIBRERIAS JAVASCRIPT -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- shpjs: Para leer Zips y Shapefiles -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

    <!-- L√ìGICA DE LA APLICACI√ìN -->
    <script>
        // --- CONFIGURACI√ìN DE DATOS ---
        const SECTOR_DATA = {
            "Agua Viva": {
                emoji: "üåä",
                color: "#0ea5e9", // Azul
                municipios: "Alejandr√≠a, Concepci√≥n, San Vicente Ferrer, San Rafael, Pe√±ol, Guatap√©",
                descripcion: `El sector Agua Viva corresponde a una subregi√≥n estrat√©gica del Oriente Antioque√±o caracterizada por su alta importancia h√≠drica, asociada a sistemas de embalses, cuencas abastecedoras y zonas de regulaci√≥n ecosist√©mica. Este sector cumple un rol fundamental en la provisi√≥n de servicios ecosist√©micos relacionados con el recurso h√≠drico, tanto a escala regional como metropolitana.`
            },
            "Bosques del Sur": {
                emoji: "üå≥",
                color: "#16a34a", // Verde
                municipios: "Sons√≥n, El Carmen de Viboral, San Francisco, Nari√±o",
                descripcion: `El sector Bosques del Sur agrupa municipios que conservan extensas √°reas de cobertura boscosa y ecosistemas estrat√©gicos de monta√±a, fundamentales para la conectividad ecol√≥gica entre el Oriente Antioque√±o y otras regiones del departamento. Esta sub√°rea presenta una alta diversidad biol√≥gica y cumple funciones clave como refugio de fauna.`
            },
            "Corredor Granadino": {
                emoji: "üåø",
                color: "#84cc16", // Lima
                municipios: "Cocorn√°, San Luis, San Carlos, Granada",
                descripcion: `El Corredor Granadino constituye una franja de conexi√≥n ecol√≥gica clave dentro del Oriente Antioque√±o, articulando ecosistemas de bosque, zonas agr√≠colas y √°reas de transici√≥n entre regiones. Su ubicaci√≥n estrat√©gica lo convierte en un eje fundamental para la movilidad de especies y el flujo de procesos ecol√≥gicos a escala regional.`
            },
            "N√∫cleo de Expansi√≥n": {
                emoji: "üèôÔ∏è",
                color: "#f59e0b", // √Åmbar
                municipios: "Argelia, Abejorral, El Santuario, Rionegro, Retiro, Marinilla, La Uni√≥n, La Ceja",
                descripcion: `El sector N√∫cleo de Expansi√≥n se caracteriza por una din√°mica acelerada de crecimiento urbano, transformaci√≥n del suelo y consolidaci√≥n de infraestructuras. Este proceso genera una presi√≥n constante sobre la cobertura vegetal remanente y sobre las √°reas que funcionan como nodos de conectividad ecol√≥gica.`
            }
        };

        function getSectorInfo(name) {
            if (!name) return null;
            const n = name.toLowerCase();
            if (n.includes("agua viva")) return { key: "Agua Viva", ...SECTOR_DATA["Agua Viva"] };
            if (n.includes("bosques") || n.includes("sur")) return { key: "Bosques del Sur", ...SECTOR_DATA["Bosques del Sur"] };
            if (n.includes("granadino")) return { key: "Corredor Granadino", ...SECTOR_DATA["Corredor Granadino"] };
            if (n.includes("expansi√≥n") || n.includes("expansion")) return { key: "N√∫cleo de Expansi√≥n", ...SECTOR_DATA["N√∫cleo de Expansi√≥n"] };
            return null;
        }

        // --- INICIALIZACI√ìN DEL MAPA ---
        const map = L.map('map', { zoomControl: false }).setView([6.1, -75.3], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let geoJsonLayer; 
        let globalGeoData = null; // Guardamos referencia global a los datos

        // --- CARGAR SHAPEFILE ---
        shp('./AreaEstudio.zip').then(function(geojson) {
            
            document.getElementById('loader').style.display = 'none';

            // Manejo si el zip trae m√∫ltiples capas
            const data = Array.isArray(geojson) ? geojson[0] : geojson;
            globalGeoData = data; // Almacenar para c√°lculos posteriores

            // A√±adir al mapa
            geoJsonLayer = L.geoJSON(data, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);

            map.fitBounds(geoJsonLayer.getBounds(), { padding: [50, 50] });

        }).catch(function(error) {
            console.error(error);
            document.getElementById('loader').innerHTML = `
                <h3 style="color: #ef4444">Error al cargar el mapa</h3>
                <p>No se encontr√≥ <code>AreaEstudio.zip</code> o el archivo es inv√°lido.</p>
                <p style="font-size:0.8rem">Detalle: ${error.message}</p>
            `;
        });

        // --- ESTILOS DEL MAPA ---
        function styleFeature(feature) {
            const sectorName = feature.properties.Sector;
            const info = getSectorInfo(sectorName);
            const color = info ? info.color : '#94a3b8';

            return {
                fillColor: color,
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.5
            };
        }

        // --- INTERACCI√ìN ---
        let selectedLayer = null;

        function onEachFeature(feature, layer) {
            const props = feature.properties;
            
            // Tooltip usando el nombre correcto de columna: MPIO_CNMBR
            layer.bindTooltip(`
                <div style="text-align:center">
                    <strong>${props.MPIO_CNMBR}</strong><br>
                    <span style="font-size:0.8em">${props.Sector}</span>
                </div>
            `, { sticky: true });

            layer.on({
                mouseover: (e) => {
                    if (selectedLayer !== e.target) {
                        e.target.setStyle({ weight: 4, color: '#666', fillOpacity: 0.7 });
                        e.target.bringToFront();
                    }
                },
                mouseout: (e) => {
                    if (selectedLayer !== e.target) {
                        geoJsonLayer.resetStyle(e.target);
                    }
                },
                click: (e) => selectFeature(e.target, props)
            });
        }

        function selectFeature(layer, props) {
            if (selectedLayer) {
                geoJsonLayer.resetStyle(selectedLayer);
            }

            selectedLayer = layer;
            selectedLayer.setStyle({
                weight: 5,
                color: '#333',
                fillOpacity: 0.8,
                dashArray: ''
            });

            // L√≥gica para sumar las √°reas del municipio seleccionado
            let totalArea = 0;
            if (globalGeoData && globalGeoData.features) {
                // Filtramos por el mismo nombre de municipio
                const featuresMunicipio = globalGeoData.features.filter(f => f.properties.MPIO_CNMBR === props.MPIO_CNMBR);
                // Sumamos Shape_Area
                totalArea = featuresMunicipio.reduce((sum, f) => {
                    const area = parseFloat(f.properties.Shape_Area) || 0;
                    return sum + area;
                }, 0);
            } else {
                // Fallback por si acaso
                totalArea = parseFloat(props.Shape_Area) || 0;
            }

            updateSidebar(props, totalArea);
        }

        // --- PANEL LATERAL ---
        function updateSidebar(props, totalArea) {
            const info = getSectorInfo(props.Sector);
            const container = document.getElementById('detail-content');
            
            document.getElementById('sidebar-welcome').style.display = 'none';
            document.getElementById('sidebar-detail').style.display = 'block';
            document.getElementById('sidebar').classList.add('active');

            // Usamos MPIO_CNMBR para el t√≠tulo y el totalArea calculado
            const areaDisplay = totalArea > 0 
                ? Math.round(totalArea).toLocaleString() + ' m¬≤' 
                : 'No disponible';

            if (info) {
                container.innerHTML = `
                    <div style="width: 100%; height: 8px; background: ${info.color}; border-radius: 4px; margin-bottom: 20px;"></div>
                    
                    <div class="sector-header">
                        <div class="sector-title">
                            <span class="sector-emoji">${info.emoji}</span>
                            ${info.key}
                        </div>
                    </div>

                    <div class="info-card">
                        <span class="info-label">Municipio Seleccionado</span>
                        <div style="font-size: 1.2rem; font-weight: 600;">${props.MPIO_CNMBR}</div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">
                            √Årea Total: ${areaDisplay}
                        </div>
                    </div>

                    <div class="info-card">
                        <span class="info-label">Municipios del Sector</span>
                        <p class="info-text">${info.municipios}</p>
                    </div>

                    <div>
                        <span class="info-label">Descripci√≥n del Territorio</span>
                        <p class="info-description">${info.descripcion}</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h2>${props.Sector}</h2>
                    <p>Informaci√≥n detallada no disponible para este sector.</p>
                    <div class="info-card">
                        <strong>Municipio:</strong> ${props.MPIO_CNMBR}<br>
                        <strong>√Årea:</strong> ${areaDisplay}
                    </div>
                `;
            }
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            if (selectedLayer) {
                geoJsonLayer.resetStyle(selectedLayer);
                selectedLayer = null;
            }
        }
    </script>
</body>
</html>